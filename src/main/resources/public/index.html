<!DOCTYPE html>
<html>
<head>
          <title>US Stocks </title>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <link rel="stylesheet" href="style.css">
</head>
<body>
          <h1>Search stocks by equity name</h1>
          <form action="/stock">
                    <label for="name">Name:</label><br>
                    <input type="text" id="name" name="name" value="IBM"><br><br>
                    <input type="button" value="Submit" onclick="loadGetMsg()">
          </form>
          <div id="getrespmsg" class="card" style="display: none">
          </div>
          <table id="myTable" style="display: none">
                    <tr class="table-header">
                              <th>Date</th>
                              <th>Open</th>
                              <th>High</th>
                              <th>Low</th>
                              <th>Close</th>
                              <th>Volume</th>
                    </tr>
          </table>

          <script>
                    let cache = {};


                    function loadGetMsg() {
                              let nameVar = document.getElementById("name").value;
                              if ( nameVar in cache ) {
                                        console.log("CACHE");
                                        buildTable(cache[nameVar]);
                                        buildCard(cache[nameVar]);
                              }
                              else {
                                        const xhttp = new XMLHttpRequest();
                                        xhttp.onload = function() {
                                                  // document.getElementById("getrespmsg").innerHTML = this.responseText;
                                                  cache[nameVar] = JSON.parse(this.responseText);
                                                  buildTable(JSON.parse(this.responseText));
                                                  buildCard(JSON.parse(this.responseText));
                                        }
                                        xhttp.open("GET", "/stock?name="+nameVar);
                                        xhttp.send();
                              }
                    }

                    function buildTable(json){
                              cleanElements([...document.getElementsByClassName("row")]);
                              let table = document.getElementById("myTable");
                              table.style.display = "";
                              let mainData =  json["Time Series (Daily)"];
                              for(key in mainData){
                                        let keyData = mainData[key];
                                        let dataArray = [];
                                        for(data in keyData){
                                                  dataArray.push(keyData[data]);
                                        }
                                        let row = `<tr class="row">
                                                                      <td>${key}</td>
                                                                      <td>${dataArray[0]}</td>
                                                                      <td>${dataArray[1]}</td>
                                                                      <td>${dataArray[2]}</td>
                                                                      <td>${dataArray[3]}</td>
                                                                      <td>${dataArray[4]}</td>
                                                            </tr>`
                                        table.innerHTML += row;
                              }
                    }
                    function buildCard(json){
                              let card = document.getElementById("getrespmsg");
                              cleanElements([...card.children]);
                              card.style.display = "";
                              let mainData =  json["Meta Data"];
                              let dataArray = [];
                              for(key in mainData){
                                        dataArray.push(mainData[key]);
                              }
                              let table = document.getElementById("myTable");
                              let cardHTML = `<h4>General Info</h4>
                                                  <p>Symbol: ${dataArray[1]}</p>
                                                  <p>Last Refreshed: ${dataArray[2]}</p>
                                                  <p>Output Size: ${dataArray[3]}</p>
                                                  <p>Time Zone: ${dataArray[4]}</p>`
                              
                              card.innerHTML += cardHTML;
                    }
                    function cleanElements(elements) {
                              if(elements.length > 0) {
                                        for(element of elements){
                                                  element.remove();
                                        };
                              }
                    }
          </script>

</body>
</html>